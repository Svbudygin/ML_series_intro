# ะะตัะตะบัะพั ะทะฐััะฐะฒะพะบ ะฒยัะตัะธะฐะปะฐั

ะะพะปะฝัะน, ะฒะพัะฟัะพะธะทะฒะพะดะธะผัะน ะฟะฐะนะฟะปะฐะนะฝ, ะบะพัะพััะน ะฝะฐ ะฒัะพะด ะฟะพะปััะฐะตั ัะตัะธะธ ะฒยัะพัะผะฐัะตยMP4, ะฐยะฝะฐ ะฒััะพะดะตยโ JSONโัะฐะนะป ัยะฒัะตะผะตะฝะตะผ ะฝะฐัะฐะปะฐ ะธยะบะพะฝัะฐ ะบะพัะพัะบะพะน ะทะฐััะฐะฒะบะธ (ะธะฝััะพ).


---
## ๐ ะัะดะฐ ะฟะพะปะพะถะธัั ะดะฐะฝะฝัะต
```
ML_series_intro/
โโโ data/
    โโโ raw/
        โโโ labels/                    # train_labels.json, test_labels.json
        โโโ episodes/                 # ะปัะฑัะต ะฟะพะดะฟะฐะฟะบะธ ั mp4โัะฐะนะปะฐะผะธ
            โโโ data_test_short/
            โ   โโโ -220020068_456241671/-220020068_456241671.mp4
            โ   โโโ -220020068_456249204/...
            โโโ ...
```

ะะพัะปะต ะทะฐะฟััะบะฐ ะบะพะฝะฒะตะนะตัะฐ ะดะตัะตะฒะพ ะฟัะพะตะบัะฐ ะฟะพััะตะฟะตะฝะฝะพ ะฝะฐะฟะพะปะฝัะตััั ัะฐะบ:
```
ML_series_intro/
โโโ data/
โ   โโโ raw/labels/โฆ                       # ะธััะพะดะฝะฐั ัะฐะทะผะตัะบะฐ
โ   โโโ raw/episodes/โฆ                     # ะฒัะต mp4
โ   โโโ interim/                           # ะฟัะพะผะตะถััะพัะบะฐ
โ   โ   โโโ cleaned_labels.csv             # ะณะพัะพะฒะฐั ัะฐะทะผะตัะบะฐ
โ   โ   โโโ suspects.csv                   # ะฟะพะดะพะทัะธัะตะปัะฝัะต ะธะฝัะตัะฒะฐะปั
โ   โ   โโโ episode_<id>/                  # ะพะดะธะฝ ะบะฐัะฐะปะพะณ ะฝะฐ ัะฟะธะทะพะด
โ   โ       โโโ frames/ *.jpg              # ะบะฐะดัั +-1ยfps
โ   โ       โโโ frames_meta.csv            # ยซะบะฐะดัโะฒัะตะผัยป
โ   โ       โโโ mels/ mel_*.npy            # ะฐัะดะธะพโัะฟะตะบััั
โ   โ       โโโ video_embeds.npy           # Tร512 CLIPโะฒะตะบัะพัั
โ   โ       โโโ audio_embeds.npy           # Tร128 Melโะฒะตะบัะพัั
โ   โโโ processed/
โ       โโโ windows_train.parquet          # ะพะบะฝะฐ +ยะผะตัะบะฐ
โ       โโโ windows_test.parquet           # ะพะบะฝะฐ ะฑะตะท ะผะตัะบะธ (ะตัะปะธ ะตััั)
โ       โโโ windows_pred.parquet           # score ะผะพะดะตะปะธ
โโโ models/
โ   โโโ lightgbm_intro.txt                 # ะฑะธะฝะฐัั LightGBM
โ   โโโ lightgbm_intro.json                # ะผะตัะฐโะธะฝัะพ (AUC, ะธัะตัะฐัะธะธ)
โ   โโโ feature_importances.csv            # ัะพะฟ ัะธั
โโโ results/
โ   โโโ intro_segments.json                # ัะธะฝะฐะปัะฝัะต ะธะฝััะพโะธะฝัะตัะฒะฐะปั
โโโ notebooks/analysis.ipynb               # ะณัะฐัะธะบะธ + EDA
โโโ src/                                   # ะฒะตัั ะบะพะด ะบะพะฝะฒะตะนะตัะฐ
```
---
## 0ยโ ะะพะดะณะพัะพะฒะบะฐ ะพะบััะถะตะฝะธั
```bash
python -m venv venv && source venv/bin/activate
pip install --upgrade pip
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
pip install open-clip-torch librosa tqdm pandas pyarrow pillow lightgbm
```

---
## 1ยโ ะัะธััะบะฐ ัะฐะทะผะตัะบะธ
```bash
python src/data/clean_labels.py \
  --train data/raw/labels/train_labels.json \
  --test  data/raw/labels/test_labels.json  \
  --out_dir data/interim
```
*ะัะฟัะฐะฒะปัะตั ะฝะตะฒะตัะฝัะต ะธะฝัะตัะฒะฐะปั, ัะดะฐะปัะตั ะดัะฑะปะธะบะฐัั ะธยะฒัะฑัะพัั.*  
> ะััะพะด: `data/interim/cleaned_labels.csv`

---
## 2ยโ ะะทะฒะปะตัะตะฝะธะต ะบะฐะดัะพะฒ ะธยะฐัะดะธะพ
### 2.1ยะะฐะดัั (ffmpeg, 1ยfps)
```bash
for vid in data/raw/episodes/*/*/*.mp4; do
  id=$(basename "$(dirname "$vid")")          # ยซ-220020068_456241671ยป
  python src/data/extract_frames.py \
    --video   "$vid" \
    --out_dir data/interim/episode_"$id" \
    --fps 1
done
```
ะกะพะทะดะฐัััั `frames/*.jpg` + `frames_meta.csv`.

### 2.2ยะัะดะธะพยโ ะผะตะปโัะฟะตะบััั
```bash
for vid in data/raw/episodes/*/*/*.mp4; do
  id=$(basename "$(dirname "$vid")")
  python src/data/extract_audio.py \
    --video   "$vid" \
    --out_dir data/interim/episode_"$id"
done
```
ะกะพะทะดะฐัััั `mels/mel_000000.npy` (ะฟะพ ะพะดะฝะพะผั ัะฐะนะปั ะฝะฐยัะตะบัะฝะดั).

---
## 3ยโ ะะตะบัะพัะธะทะฐัะธั ัะผะฑะตะดะดะธะฝะณะพะฒ
### 3.1ยะะธะดะตะพ (CLIP)
```bash
for ep in data/interim/episode_*; do
  python src/features/video_embeddings.py \
    --meta "$ep/frames_meta.csv" \
    --out  "$ep/video_embeds.npy" \
    --device cpu
done
```
### 3.2ยะัะดะธะพ (ััะตะดะฝะธะน Mel)
```bash
for ep in data/interim/episode_*; do
  python src/features/audio_embeddings.py \
    --mels_dir "$ep/mels" \
    --out      "$ep/audio_embeds.npy"
done
```

---
## 4ยโ ะคะพัะผะธัะพะฒะฐะฝะธะต ัะบะพะปัะทััะธั ะพะบะพะฝ
```bash
python src/data/build_windows.py \
  --interim_dir    data/interim \
  --cleaned_labels data/interim/cleaned_labels.csv \
  --out_dir        data/processed \
  --min_sec 3 --max_sec 12 --step_sec 1 \
  --workers 4       # ัะธัะปะพ ะฟะพัะพะบะพะฒ = ัะดะตั CPU
```
*ะะบะฝะพ โช12ยั ัะดะฒะธะณะฐะตััั ะบะฐะถะดัั ัะตะบัะฝะดั; ัััะตะดะฝััััั ัะผะฑะตะดะดะธะฝะณะธ โยัะฐะฑะปะธัะฐ ัะธั.*  
> `windows_train.parquet` (ัยะผะตัะบะพะน `is_intro`), `windows_test.parquet` (ะตัะปะธ ะตััั ัะฟะธะทะพะดั ะฑะตะท ะปะตะนะฑะปะพะฒ).

---
## 5ยโ ะะฑััะตะฝะธะต LightGBM
```bash
python src/train.py \
  --train_parquet data/processed/windows_train.parquet \
  --model_out     models/lightgbm_intro.txt \
  --imp_out       models/feature_importances.csv
```
ะกะพััะฐะฝัะตััั ะผะพะดะตะปั ะธยะฒะฐะถะฝะพััั ัะธั.

---
## 6ยโ ะัะตะดัะบะฐะทะฐะฝะธั ะพะบะพะฝ
```bash
python src/predict.py \
  --model   models/lightgbm_intro.txt \
  --windows data/processed/windows_train.parquet \
  --out     data/processed/windows_pred.parquet
```
*(ะตัะปะธ `windows_test.parquet` ะฝะต ะฟัััะพะนยโ ะผะตะฝัะนัะต ะฟััั)*

---
## 7ยโ ะกะบะปะตะนะบะฐ ะพะบะพะฝ ะฒยะตะดะธะฝัั ะทะฐััะฐะฒะบั
```bash
python src/postprocess.py \
  --pred data/processed/windows_pred.parquet \
  --out  results/intro_segments.json \
  --thr  0.6
```
ะะปะณะพัะธัะผ ะณััะฟะฟะธััะตั ัะพัะตะดะฝะธะต ะพะบะฝะฐ ัะพ scoreยโฅย0.6 ะธยะพััะตะทะฐะตั ัะปะธัะบะพะผ ะบะพัะพัะบะธะต/ะดะปะธะฝะฝัะต.

---
## 8ยโ ะัะพะฒะตัะบะฐ ะบะฐัะตััะฒะฐ (IoU)
```bash
python src/evaluate.py \
  --labels      data/interim/cleaned_labels.csv \
  --predictions results/intro_segments.json
```
ะัะฒะพะดะธั IoU ะดะปั ะบะฐะถะดะพะณะพ ัะฟะธะทะพะดะฐ ะธยััะตะดะฝะธะน.

---
ะะฝัััะธ: ะธะทะฒะปะตะบะฐะตั ะบะฐะดัั+ะฐัะดะธะพ โ ัะผะฑะตะดะดั โ ะพะบะฝะฐ โ ะฟัะตะดัะบะฐะทะฐะฝะธะต โ ะฟะพััโะพะฑัะฐะฑะพัะบะฐ.

---
## ๐ ะะฝะฐะปะธัะธะบะฐ ัะตะทัะปััะฐัะพะฒ
ะ ะฟะฐะฟะบะต `notebooks/` ะปะตะถะธั `analysis.ipynb`, ะณะดะต ัััะพัััั:
- ะปะพะณโะณะธััะพะณัะฐะผะผะฐ `intro_score`
- ัะฐัะฟัะตะดะตะปะตะฝะธะต ะฟะพะปะพะถะตะฝะธั ะพะบะพะฝ ัยะฒััะพะบะธะผ score
- ะณัะฐัะธะบะธ scoreยะฟะพยะฒัะตะผะตะฝะธ ะดะปั ะฒัะฑัะฐะฝะฝัั ัะฟะธะทะพะดะพะฒ

> **ะกะพะฒะตั:** ะฟะพัะปะต ะทะฐะฟััะบะฐ ะฝะพััะฑัะบะฐ ัะดะตะปะฐะนัะต ัะบัะธะฝัะพั ะณัะฐัะธะบะพะฒ ะธยะฟัะธะบัะตะฟะธัะต ะฒยะพัััั.

---
## ะจะฐะณะธ ะบะพะฝะฒะตะนะตัะฐ ะฒยะดะฒัั ัะปะพะฒะฐั
| ะจะฐะณ | ะะฐะทะฝะฐัะตะฝะธะต |
|-----|-------------|
| **ะัะธััะบะฐ ะปะตะนะฑะปะพะฒ** | ะฃะฑะธัะฐะตะผ ะพัะธะฑะบะธ ัะฐะทะผะตัะบะธ, ััะพะฑั ะผะพะดะตะปั ััะธะปะฐัั ะฝะฐยัะธัััั ะดะฐะฝะฝัั |
| **ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั** | ะัะตะฒัะฐัะฐะตะผ ะฒะธะดะตะพ ะฒยะบะฐะดัั ะธยะทะฒัะบะพะฒัั ยซะบะฐััะธะฝะบัยป |
| **ะญะผะฑะตะดะดะธะฝะณะธ** | CLIPย+ ััะตะดะฝะธะน Melยโ ะบะพะผะฟะฐะบัะฝัะต ะฒะตะบัะพัั ะฒะผะตััะพ ยซัััััยป ะฟะธะบัะตะปะตะน |
| **ะะบะฝะฐ** | ะกะผะพััะธะผ ะฝะฐยััะฐะณะผะตะฝัั 3โ12ยัยะธยะฟะพะผะตัะฐะตะผ, ะฟะพะฟะฐะดะฐัั ะปะธ ะพะฝะธ ะฒยะทะฐััะฐะฒะบั |
| **LightGBM** | ะฃัะธะผ ะฑะธะฝะฐัะฝัะน ะบะปะฐััะธัะธะบะฐัะพั ยซะพะบะฝะพยโ ะธะฝััะพ / ะฝะต ะธะฝััะพยป |
| **Postโprocessing** | ะกะบะปะตะธะฒะฐะตะผ ะพะบะฝะฐ, ะฟะพะปััะฐะตะผ ะพะดะธะฝ ัะธัััะน ะธะฝัะตัะฒะฐะป ะธะฝััะพ |
| **Evaluation** | ะัะพะฒะตััะตะผ IoU, ะฟะพะดะฑะธัะฐะตะผ ะฟะพัะพะณ |

